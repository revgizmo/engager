name: Performance Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  performance:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        r-version: [4.1, 4.2, 4.3]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up R
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: ${{ matrix.r-version }}
    
    - name: Install dependencies
      run: |
        Rscript -e "install.packages(c('remotes', 'testthat', 'microbenchmark', 'pryr'))"
        Rscript -e "remotes::install_deps(dep = TRUE)"
    
    - name: Run performance tests
      run: |
        Rscript -e "devtools::test(filter = 'performance')"
    
    - name: Run benchmarks
      run: |
        Rscript scripts/benchmark-ideal-transcripts.R 3 benchmark_results.rds
    
    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results-${{ matrix.r-version }}
        path: benchmark_results.rds