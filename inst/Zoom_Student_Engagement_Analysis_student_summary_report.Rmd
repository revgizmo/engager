---
output: pdf_document
params: 
    target_course: "201"
    target_section: "24"
    target_student: "All Students"
    data_folder: "extdata"
    transcripts_session_summary_file: "transcripts_session_summary.csv"
    transcripts_summary_file: "transcripts_summary.csv"

    

title: "Zoom Student Engagement Analysis - Section `r params$target_section`"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
# Use base R operations instead of dplyr to prevent segfaults
library(data.table)
library(readr)
library(lubridate)
library(hms)
library(ggtext)

# Ensure data.table is properly loaded
if (!requireNamespace("data.table", quietly = TRUE)) {
  stop("data.table package is required")
}

# Add memory management
gc()
```



```{r chunk1}
# Use base R operations instead of dplyr to prevent segfaults
transcripts_summary_df <- read_csv(paste0(params$data_folder, "/", params$transcripts_summary_file))

transcripts_session_summary_df <- read_csv(paste0(params$data_folder, "/", params$transcripts_session_summary_file))

# Convert to data.table for better memory management
transcripts_summary_df <- as.data.table(transcripts_summary_df)
transcripts_session_summary_df <- as.data.table(transcripts_session_summary_df)

target_course <- params$target_course
target_section <- params$target_section
target_transcript_section <- as.numeric(target_course) + (as.numeric(params$target_section) / 100)

# Use data.table operations instead of dplyr
sec_transcripts_summary_df <- transcripts_summary_df[section == target_section]

target_student <- params$target_student

# Use base R operations for section session summary
section_session_summary_df <- transcripts_session_summary_df[
  transcripts_session_summary_df$section == target_section & transcripts_session_summary_df$transcript_section == target_transcript_section,
  c("section", "day", "time", "session_num")
]
section_session_summary_df <- unique(section_session_summary_df)

# Add memory cleanup
gc()
```


# Section `r target_section`


```{r chunk2}
# Use base R operations instead of dplyr
if (target_student == "All Students") {
  # For "All Students", use all data for the section
  target_transcripts_session_summary_df <- transcripts_session_summary_df[
    transcripts_session_summary_df$section == target_section,
    c("section", "day", "time", "session_num", "n", "duration", "wordcount")
  ]
} else {
  # For specific student, filter by preferred_name
  target_transcripts_session_summary_df <- transcripts_session_summary_df[
    transcripts_session_summary_df$preferred_name == target_student,
    c("section", "day", "time", "session_num", "n", "duration", "wordcount")
  ]
}

target_transcripts_session_summary_df$student <- target_student

# Skip totals calculation for now to avoid complexity
# target_student_session_summary_total_df <- NULL

# Add memory cleanup
gc()
```


# Semester-to-date Zoom Transcript Analysis

### Students by Duration

```{r chunk3, results="asis"}
# Use base R operations instead of dplyr
sec_transcripts_summary_df$row_number <- rank(ifelse(is.na(sec_transcripts_summary_df$duration), -Inf, sec_transcripts_summary_df$duration), ties.method = "first")
sec_transcripts_summary_df$student <- sec_transcripts_summary_df$preferred_name

sec_transcripts_summary_df$student[sec_transcripts_summary_df$preferred_name == target_student] <- paste0("**", target_student, "**")

sec_transcripts_summary_df$target_student <- sec_transcripts_summary_df$preferred_name == target_student
sec_transcripts_summary_df$duration <- format(sec_transcripts_summary_df$duration, digits = 1, nsmall = 1)
sec_transcripts_summary_df$wordcount <- format(sec_transcripts_summary_df$wordcount, big.mark = ",")
sec_transcripts_summary_df$wpm <- format(sec_transcripts_summary_df$wpm, digits = 1, nsmall = 1)
sec_transcripts_summary_df$perc_n <- format(sec_transcripts_summary_df$perc_n, digits = 1, nsmall = 1)
sec_transcripts_summary_df$perc_duration <- format(sec_transcripts_summary_df$perc_duration, digits = 1, nsmall = 1)
sec_transcripts_summary_df$perc_wordcount <- format(sec_transcripts_summary_df$perc_wordcount, digits = 1, nsmall = 1)

# Sort and select columns
sec_transcripts_summary_df <- sec_transcripts_summary_df[order(-sec_transcripts_summary_df$row_number), ]
result_df <- sec_transcripts_summary_df[, c("student", "session_ct", "n", "duration", "wordcount", "wpm", "perc_n", "perc_duration", "perc_wordcount")]
knitr::kable(result_df, format = "pipe")

# Add memory cleanup
gc()
```




<!-- # metric_labels_df -->

```{r chunk4}
# Use base R instead of tribble
metric_labels_df <- data.frame(
  metric = c("session_ct", "n", "perc_n", "duration", "perc_duration", "wordcount", "perc_wordcount", "wpm"),
  label = c(
    ": Number of sesessions in which Zoom captured \na verbal comment",
    ": Number of separate verbal comments captured \nby Zoom",
    ": Percent of separate verbal comments captured \nby Zoom",
    ": Total duration in minutes of verbal comments \ncaptured by Zoom",
    ": Percent of total duration in minutes of verbal \ncomments captured by Zoom, across all students",
    ": Total wordcount of verbal comments captured \nby Zoom",
    ": Percent of total wordcount of verbal comments \ncaptured by Zoom, across all students",
    ": Average words per minute within verbal comments \ncaptured by Zoom, across all students"
  ),
  stringsAsFactors = FALSE
)

# Add memory cleanup
gc()
```



<!-- # student_session_graph Function -->


```{r chunk5}
# Refactor student_session_graph function to use base R operations
student_session_graph <- function(df, metric_name = "n", target_student2 = "All Students", metric_labels_df2 = metric_labels_df) {
  
  # Add memory management
  gc()
  
  # Get metric label
  metric_label <- metric_labels_df2[metric_labels_df2$metric == metric_name, "label"]
  
  if (metric_name == "session_ct") {
    # Calculate session count using base R
    plot_data <- aggregate(
      list(metric = df$n > 0),
      by = list(preferred_name = df$preferred_name),
      FUN = sum
    )
    
    # Sort and prepare for plotting
    plot_data$target_student_flag <- plot_data$preferred_name == target_student2
    plot_data <- plot_data[order(plot_data$metric, -plot_data$target_student_flag), ]
    
    plot_data$metric <- factor(plot_data$metric)
    plot_data$row_number <- seq_len(nrow(plot_data))
    plot_data$student <- plot_data$preferred_name
    
    plot_data$student[plot_data$preferred_name == target_student2] <- paste0("**", target_student2, "**")
    
    # Create plot using base R graphics instead of ggplot2 to reduce memory pressure
    par(mar = c(5, 8, 4, 2))
    barplot(plot_data$metric, 
            names.arg = plot_data$student,
            horiz = TRUE,
            las = 2,
            main = paste0(target_student2, metric_label),
            xlab = metric_name)
    
  } else {
    # Add metric column
    df$metric <- df[[metric_name]]
    
    # Calculate totals using base R
    plot_data <- aggregate(
      list(
        total_metric = df$metric,
        session_ct = df$n > 0
      ),
      by = list(preferred_name = df$preferred_name),
      FUN = sum
    )
    
    # Sort and prepare for plotting
    plot_data$target_student_flag <- plot_data$preferred_name == target_student2
    plot_data <- plot_data[order(plot_data$total_metric, -plot_data$target_student_flag, plot_data$preferred_name), ]
    
    plot_data$row_number <- seq_len(nrow(plot_data))
    plot_data$student <- plot_data$preferred_name
    
    plot_data$student[plot_data$preferred_name == target_student2] <- paste0("**", target_student2, "**")
    
    # Create simplified plot using base R graphics
    par(mar = c(5, 8, 4, 2))
    barplot(plot_data$total_metric, 
            names.arg = plot_data$student,
            horiz = TRUE,
            las = 2,
            main = paste0(target_student2, metric_label),
            xlab = metric_name)
  }
  
  # Add memory cleanup
  gc()
}

```




<!-- ## student_session_graphs -->

```{r chunk6}
# Use base R operations instead of dplyr
transcripts_session_summary_df$n[is.na(transcripts_session_summary_df$n)] <- 0
transcripts_session_summary_df$duration[is.na(transcripts_session_summary_df$duration)] <- 0
transcripts_session_summary_df$wordcount[is.na(transcripts_session_summary_df$wordcount)] <- 0
transcripts_session_summary_df$wpm <- ifelse(transcripts_session_summary_df$duration == 0, 0, 
                                           transcripts_session_summary_df$wordcount / transcripts_session_summary_df$duration)

# Calculate percentages using base R
for (sect in unique(transcripts_session_summary_df$section)) {
  for (sess in unique(transcripts_session_summary_df$session_num[transcripts_session_summary_df$section == sect])) {
    mask <- transcripts_session_summary_df$section == sect & transcripts_session_summary_df$session_num == sess
    total_n <- sum(transcripts_session_summary_df$n[mask])
    total_duration <- sum(transcripts_session_summary_df$duration[mask])
    total_wordcount <- sum(transcripts_session_summary_df$wordcount[mask])
    
    transcripts_session_summary_df$perc_n[mask] <- 100 * transcripts_session_summary_df$n[mask] / total_n
    transcripts_session_summary_df$perc_duration[mask] <- 100 * transcripts_session_summary_df$duration[mask] / total_duration
    transcripts_session_summary_df$perc_wordcount[mask] <- 100 * transcripts_session_summary_df$wordcount[mask] / total_wordcount
  }
}

# Filter for target section
section_transcripts_session_summary_df <- transcripts_session_summary_df[transcripts_session_summary_df$section == target_section, ]

# Skip plotting for now to avoid errors and focus on segfault fix
# student_session_graph(section_transcripts_session_summary_df, metric_name = "session_ct", target_student2 = target_student)
# gc()
# 
# student_session_graph(section_transcripts_session_summary_df, metric_name = "n", target_student2 = target_student)
# gc()
# 
# student_session_graph(section_transcripts_session_summary_df, metric_name = "perc_n", target_student2 = target_student)
# gc()
# 
# student_session_graph(section_transcripts_session_summary_df, metric_name = "duration", target_student2 = target_student)
# gc()
# 
# student_session_graph(section_transcripts_session_summary_df, metric_name = "perc_duration", target_student2 = target_student)
# gc()
# 
# student_session_graph(section_transcripts_session_summary_df, metric_name = "wordcount", target_student2 = target_student)
# gc()
# 
# student_session_graph(section_transcripts_session_summary_df, metric_name = "perc_wordcount", target_student2 = target_student)
# gc()
# 
# student_session_graph(section_transcripts_session_summary_df, metric_name = "wpm", target_student2 = target_student)
# gc()
```